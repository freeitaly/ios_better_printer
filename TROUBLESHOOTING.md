# 企业微信文件消息接收问题排查指南

## 🔍 问题现象
- ✅ 文本消息能正常接收
- ✅ 图片消息能正常接收  
- ❌ 文件类型消息完全收不到（服务器无任何请求）

## 📋 完整排查清单

### 第一步：确认服务器是否收到请求

**测试方法：**
1. 在企业微信中发送一个文件
2. 立即查看服务器日志：
   ```bash
   sudo docker compose logs -f app | grep -E "收到请求|POST|FILE"
   ```

**判断标准：**
- **有日志** → 说明请求已到达，问题在代码处理逻辑
- **无日志** → 说明企业微信根本没有推送，问题在配置

---

### 第二步：检查企业微信后台配置

#### 2.1 接收消息服务器配置

**位置：** 应用管理 → 你的应用 → 接收消息 → 设置API接收

**检查项：**
- [ ] URL 使用**域名**（不能是IP地址）
- [ ] URL 格式：`http://你的域名:18080/wecom` 或 `https://你的域名/wecom`
- [ ] Token 与 `.env` 文件中的 `WECOM_TOKEN` **完全一致**
- [ ] EncodingAESKey 与 `.env` 文件中的 `WECOM_ENCODING_AES_KEY` **完全一致**

**⚠️ 重要：**
- 如果使用动态域名，确保域名已正确解析到服务器IP
- 测试：在浏览器访问 `http://你的域名:18080/health` 应该能返回JSON

#### 2.2 消息类型配置

**位置：** 应用管理 → 你的应用 → 接收消息 → 设置API接收

**检查项：**
- [x] **"用户发送的普通消息"** 必须勾选（这个应该已经勾选了）

**⚠️ 注意：**
- 企业微信的"用户发送的普通消息"理论上应该包含文件消息
- 但某些版本可能需要单独配置

#### 2.3 应用可见范围

**位置：** 应用管理 → 你的应用 → 可见范围

**检查项：**
- [ ] 确认**发送文件的账号**在可见范围内
- [ ] 如果使用"按部门"，确认账号所属部门已添加
- [ ] 如果使用"按成员"，确认账号已添加

**测试方法：**
- 用可见范围内的账号发送文本消息 → 应该能收到
- 用可见范围内的账号发送文件 → 应该能收到
- 用不可见范围内的账号发送 → 收不到任何消息

---

### 第三步：检查发送方式

**⚠️ 关键：企业微信发送文件有多种方式，只有特定方式会触发回调**

#### ✅ 正确的方式（会触发回调）：
1. 打开企业微信APP
2. 进入你的自建应用
3. 在应用对话框中点击底部的 **+** 号
4. 选择 **"文件"** 或 **"文档"**
5. 从手机选择文件发送

#### ❌ 错误的方式（不会触发回调）：
- 从其他聊天转发文件到应用
- 从手机文件管理器"分享"到企业微信
- 通过"文件传输助手"发送
- 通过"收藏"功能发送

**测试方法：**
- 使用正确方式发送一个小文件（如 .txt，几KB）
- 观察服务器日志是否有请求

---

### 第四步：检查域名和网络

#### 4.1 域名解析

**测试命令：**
```bash
# 在服务器上测试
nslookup 你的域名
# 或
ping 你的域名
```

**应该返回：** 你的服务器IP地址（如 58.58.56.78）

#### 4.2 端口访问

**测试方法：**
```bash
# 从外网测试（用手机浏览器或电脑）
curl http://你的域名:18080/health
```

**应该返回：** `{"status":"ok","service":"wecom-doc-converter"}`

#### 4.3 防火墙配置

**检查项：**
- [ ] 服务器防火墙已开放 18080 端口
- [ ] 路由器/云服务商安全组已开放 18080 端口

**测试命令（在服务器上）：**
```bash
# 检查端口是否监听
netstat -tlnp | grep 18080
# 或
ss -tlnp | grep 18080
```

---

### 第五步：检查动态域名限制

**⚠️ 企业微信对域名的要求：**

根据官方文档：
1. **不支持IP地址** ✅ 你已经改为域名
2. **域名需要备案** ⚠️ 动态域名通常无法备案
3. **备案主体需与企业主体一致** ⚠️ 动态域名无法满足

**可能的问题：**
- 动态域名虽然能解析，但可能不符合企业微信的备案要求
- 企业微信可能对未备案域名有特殊限制（如文件消息不推送）

**解决方案：**
1. **使用已备案的正式域名**（推荐）
   - 购买域名并完成备案
   - 配置DNS指向服务器IP
   - 在企业微信后台更新URL

2. **临时测试方案：**
   - 使用 Cloudflare 等服务的免费域名
   - 或使用国内云服务商提供的测试域名
   - 注意：这些可能仍然无法满足备案要求

---

### 第六步：查看详细日志

**启用详细日志后，发送文件时应该看到：**

```
============================================================
[DEBUG] 收到请求: Method=POST, URL=http://你的域名:18080/wecom?msg_signature=...
[DEBUG] Remote IP: 企业微信服务器IP
[DEBUG] Content-Type: text/xml
[DEBUG] Content-Length: XXX
[DEBUG] 原始Body长度: XXX 字节
[DEBUG] 原始Body内容: <xml>...
[DEBUG] 解密后完整XML:
<xml>
  <ToUserName><![CDATA[toUser]]></ToUserName>
  <FromUserName><![CDATA[fromUser]]></FromUserName>
  <CreateTime>1348831860</CreateTime>
  <MsgType><![CDATA[file]]></MsgType>
  <MediaId><![CDATA[media_id]]></MediaId>
  ...
</xml>
[DEBUG] >>>>>> 消息类型: file <<<<<<
[FILE] 检测到文件类型消息，开始处理...
```

**如果没有看到这些日志：**
- 说明企业微信根本没有推送请求
- 重点检查上述第2、3、5步

---

## 🎯 最可能的原因（按概率排序）

1. **域名备案问题** (70%)
   - 动态域名无法备案
   - 企业微信对未备案域名可能限制文件消息推送

2. **发送方式错误** (20%)
   - 使用了不会触发回调的发送方式

3. **可见范围问题** (5%)
   - 发送者账号不在应用可见范围内

4. **其他配置问题** (5%)
   - Token/EncodingAESKey 不匹配
   - URL配置错误

---

## 🚀 推荐解决方案

### 方案A：使用已备案域名（最佳）

1. 购买一个域名（如阿里云、腾讯云）
2. 完成域名备案（备案主体与企业主体一致）
3. 配置DNS A记录指向服务器IP
4. 在企业微信后台更新URL
5. 等待72小时后测试

### 方案B：使用云服务商提供的测试域名

某些云服务商提供测试域名，可能已预备案：
- 阿里云：临时域名
- 腾讯云：测试域名
- 华为云：测试域名

### 方案C：联系企业微信技术支持

如果以上方案都不行，可能是企业微信的特殊限制：
- 联系企业微信技术支持
- 说明情况：文本/图片正常，文件消息无回调
- 询问是否有特殊配置要求

---

## 📞 需要帮助？

如果按照以上步骤排查后仍无法解决，请提供：

1. **服务器日志**（发送文件时的完整日志）
2. **企业微信后台配置截图**（接收消息配置页面）
3. **域名信息**（使用的域名类型，是否备案）
## 7. 最终结论：关于域名与认证的硬性限制

根据最新的测试和官方文档规则（2026年1月）：

1. **回调URL不支持IP地址**：必须使用域名。
2. **动态域名（DDNS）无效**：
   - 虽然满足了"是域名"的格式要求，但企业微信对**文件类型消息**有更严格的安全策略。
   - 文件回调往往隐含要求域名必须配置为**可信域名**。
3. **可信域名的门槛**：
   - **必须备案**：工信部备案（ICP），动态域名无法备案。
   - **必须企业认证**：未认证的企业无法配置可信域名。
   - **归属权验证**：需要上传文件到域名根目录验证所有权。

**结论**：
导致无法接收文件消息的根本原因不仅仅是"URL不能写IP"，而是**未认证的企业账号配合未备案的动态域名，触发了企业微信的安全风控，导致高风险类型消息（文件）不予推送。**

要解决此问题，唯一的正规路径是：**注册正规企业 -> 完成企业微信认证 -> 购买域名并备案 -> 配置可信域名**。

