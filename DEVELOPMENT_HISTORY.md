# 开发历程存档

本文档记录了项目从立项到成功上线的完整开发过程，包括失败的尝试和最终的解决方案。

---

## 项目目标

> 家长在微信收到老师发送的 Word/Excel 作业文件后，能够快速转换为 PDF 并打印，解决 iPhone 打印排版错乱的问题。

---

## 阶段一：微信公众号测试号

**时间**：2026年1月初

**方案**：
- 用户关注公众号后，直接发送 Office 文件
- 服务器接收文件，转换为 PDF，返回给用户

**结果**：❌ 失败

**原因**：
微信公众号（包括测试号）**不支持接收文件类型消息**。用户只能发送文本、图片、语音、位置等，无法发送 `.doc`、`.xlsx` 等文件附件。

**结论**：微信公众号方案不可行，需要寻找其他平台。

---

## 阶段二：企业微信自建应用

**时间**：2026年1月6日-7日

**方案**：
- 注册企业微信，创建自建应用
- 配置消息回调 URL
- 用户通过企业微信 App 发送文件，服务器接收并转换

**开发内容**：
- 实现企业微信 AES 消息加解密（`wecom_api.py`）
- 实现消息回调处理（`app.py` 中的 `/wecom` 路由）
- 实现媒体文件下载、上传、应用消息发送

**测试过程**：
1. URL 验证 ✅ 成功
2. 文本消息回调 ✅ 成功
3. 图片消息回调 ✅ 成功
4. **文件消息回调 ❌ 失败**

**排查记录**：
- 文件大小 < 20MB ✅
- 使用企业微信 App 直接发送（非微信插件）✅
- "在微信插件中始终进入主页"未勾选 ✅
- 服务器 nginx/app 日志无请求 ✅

**结果**：❌ 失败

**根本原因**：
1. **平台风控限制**：企业微信对 `MsgType=file` 有更严格的安全策略
2. **可信域名门槛**：配置可信域名需要**企业认证**（营业执照）+ **域名 ICP 备案**
3. **动态域名无效**：使用 DDNS 域名无法完成归属权验证和备案

**结论**：未认证企业 + 未备案域名 = 无法接收文件消息回调。

---

## 阶段三：iOS 快捷指令

**时间**：2026年1月8日

**方案**：
- 完全绕开 IM 平台限制
- 用户通过 iOS 原生"共享"菜单调用快捷指令
- 快捷指令通过 HTTP POST 上传文件到服务器
- 服务器返回 PDF，在手机上直接预览/打印

**开发内容**：
- 新增 `/api/convert` 接口（同步返回 PDF）
- 更新 nginx 路由（120 秒超时）
- 文件大小限制提升至 100MB
- 创建 iOS 快捷指令并生成 iCloud 分享链接

**结果**：✅ 成功

**优势**：
- 无需平台认证/备案
- 原生 iOS 体验
- 支持任意 App 的共享菜单
- 完全复用 Windows Office 转换引擎

---

## 技术栈复用价值

以下技术模块虽然未在最终方案中使用，但可在其他项目中复用：

| 模块 | 文件 | 可复用场景 |
|-----|------|-----------|
| 企业微信消息加解密 | `wecom_api.py` | 企业微信机器人开发 |
| Windows Office COM 自动化 | `windows_converter_service.py` | 任何需要 Office 转换的场景 |
| 双引擎转换架构 | `converter.py` | 高可用文档转换服务 |

---

## 关键经验教训

### 1. 预研优先
在动手开发前，应先验证平台核心能力是否满足需求：
- 创建最小化 Demo 验证
- 查阅开发者社区问题反馈

### 2. 平台文档 ≠ 实际能力
- 官方文档声称支持不等于实际可用
- 未认证账号可能存在隐性 API 限制

### 3. 备选方案的重要性
本项目最终成功的关键是及时转向 iOS 快捷指令方案，而非继续纠结企业微信。

---

## 最终方案链接

- **iCloud 快捷指令**：见 `PRIVATE_LINKS.md`（不提交）
- **服务端 API**：`POST /api/convert`
