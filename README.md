# 企业微信作业排版助手

> ⚠️ **项目状态：暂停开发**
> 
> 由于企业微信自建应用无法通过API接收用户发送的文件类型消息，核心功能无法实现。详见下方[项目状态说明](#项目状态说明)。

---

## 项目简介

这是一个Office文档转PDF转换服务，采用**双引擎架构**（Windows Office + LibreOffice），确保转换后的PDF排版与Windows环境100%一致。

### 设计目标

- 在IM内闭环：直接发送文件即可转换
- 100%保真：支持调用Windows Office引擎
- 高可用：主要引擎故障时自动降级
- 即转即用：5-15秒快速转换

### 适用场景

- 家长接收老师发送的作业文件，需远程打印
- iPhone用户需要保证文档排版与Windows一致

---

## 项目状态说明

### ❌ 当前阻塞

**企业微信自建应用无法通过API接收用户发送的文件消息**：

| 消息类型 | 回调状态 |
|---------|---------|
| 文本 (text) | ✅ |
| 图片 (image) | ✅ |
| **文件 (file)** | ❌ |

### 🔍 已排查项

- [x] 文件大小 < 20MB
- [x] "在微信插件中始终进入主页"未勾选
- [x] 使用企业微信App直接发送
- [x] 代码无问题（nginx/app日志确认无请求）

---

## 开发历程

### 阶段一：微信公众号测试号

**目标**：通过微信公众号接收用户发送的Office文件，转换为PDF后返回。

**结果**：❌ 失败

**原因**：微信公众号（包括测试号）**不支持接收文件类型消息**。用户只能发送文本、图片、语音、位置等，无法发送 `.doc`、`.xlsx` 等文件附件。

### 阶段二：企业微信自建应用

**目标**：迁移到企业微信自建应用，官方文档声称支持接收 `MsgType=file` 消息。

**结果**：❌ 失败

**原因**：实际测试发现，**企业微信自建应用虽然可以在聊天窗口收到文件，但不会向回调URL推送file类型消息**。经多轮排查（文件大小、App设置、代码逻辑），确认问题出在平台侧。

### 阶段三：放弃

**决定**：暂停项目开发。

**考虑的替代方案**：
- Web上传页面（可行，但不如IM方便）
- Telegram Bot（可行，但需科学上网）
- 完成企业微信认证后再试（需营业执照）

---

## 经验教训

### 1. 预研不充分

在动手开发前，应先验证平台核心能力是否满足需求。例如：

```bash
# 应该先做的测试
1. 创建最小化Demo，验证能否接收文件消息
2. 查阅开发者社区，确认是否有类似问题反馈
```

### 2. 平台限制难以预判

- 官方文档声称支持 ≠ 实际可用
- 未认证企业可能存在隐性API限制
- 不同客户端（App vs 微信插件）行为不同

### 3. 已验证可用的技术栈

以下功能经验证正常工作，可在其他项目复用：

| 功能 | 状态 |
|-----|------|
| Windows Office COM自动化转换 | ✅ |
| WPS Office COM自动化转换 | ✅ |
| LibreOffice headless转换 | ✅ |
| 企业微信消息加解密 | ✅ |
| 企业微信主动发送消息 | ✅ |

---

## 项目结构

```
ios_better_printer/
├── app.py              # Flask主应用
├── wecom_api.py        # 企业微信API封装
├── converter.py        # 文档转换引擎
├── config.py           # 配置管理
├── Dockerfile          # Docker镜像
├── docker-compose.yml  # 服务编排
├── nginx.conf          # Nginx配置
├── windows_converter_service.py  # Windows转换服务
├── DEPLOYMENT.md       # 部署指南
└── LICENSE             # MIT许可证
```

## 使用注意事项

### 如果你想尝试此项目

1. **企业微信限制**：未认证企业可能无法接收file消息回调
2. **微信公众号限制**：公众号不支持接收文件消息
3. **建议**：先做最小化验证，确认平台能力后再开发

### 替代方案建议

如果你有类似需求，建议：
- **Web上传**：做一个简单的网页，用户上传文件后下载PDF
- **邮件**：用户发送邮件附件，服务器定时处理
- **Telegram Bot**：完全支持接收文件（需科学上网）

## 许可证

MIT License
